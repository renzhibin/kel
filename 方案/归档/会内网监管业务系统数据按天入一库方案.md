附件 2

会内网监管业务系统数据按天入一库方案

一、总体概述
（一）背景
当前，会内网监管业务系统数据已实现按季度导入一库，通过专用移动硬盘等数据通道完成数据导出，涵盖发行、上市等系统。
由于数据应用的持续开展，现计划开展会内网监管业务数据每日入一库工作。为避免数据重复和有效利用资源，原则上导出入库的数据应是内网产生的有监管业务信息的数据，其他由证联网采集入内网的数据可通过证网直接入库，无业务含义的技术表不入库。数据入库的频率以业务数据实际发生变化的频度为准。鉴于一库部署于证联网，与会内监管业务系统物理隔离，因此需将会内数据导出为文件，经科技司和信息中心批准后，实现数据导出证网完成数据入库。
（二）数据范围
目前已初步梳理包括上市系统、发行系统等9个系统约800多张业务数据表（附件1、2），非结构化文件暂不纳入本次入库范围。后续建立动态调整机制，支持根据业务发展和技术变化定期评估和调整入库范围。
（三）接口规范
中证技术依据入库范围清单，根据数据表的实际情况填写数据表和数据字段的基本情况，包括数据表的大小、更新方式、明确传输频度、传输时间、字段数据类型等，中证数据基于此信息生成接口规范。如发生业务系统变更数据结构情况，由中证技术通过邮件方式将变更数据表和字段的基本信息，及时通知中证数据。
（四）总体架构
基于上述业务数据情况及现有会内网监管数据入库模式，结合会内网与证联网物理隔离的实际情况，整体数据入库流程需兼顾安全、传输效率与规范。下图展示了监管业务数据入一库的总体架构、流程和分工：

第一步：业务系统数据卸载准备。在明确入一库的数据范围后，业务系统需根据接口规范进行数据卸载准备。中证数据商中证技术结合业务实际情况，原则上采用数据表增量卸载方式。针对需增量但不具备增量导出条件的数据表，中证技术需进行相关适配改造。针对全量数据较小或短期紧急的数据表，可结合实际情况全量卸载。
第二步：数据卸载。在业务系统完成导出数据标识的改造后，需通过卸载脚本将数据库数据按照接口规范约定转换为TXT格式的结构化文件（TXT文件格式的编码、分隔符等按照中证数据接口规范的格式要求），每天卸载一次。
第三步：数据导出。将会内网卸载的数据按实际情况进行压缩加密处理并生成校验文件后，刻盘导出至证联网的数据交换区。数据表首次上线时，需要按照接口规范提供历史全量数据TXT文件。
第四步：数据入库。通过数据交换工具将证联网数据交换区的TXT文件传输至一库接口服务器，按需进行解压解密和校验后，将TXT文件入库至一库。
二、技术实现
（一）数据准备
数据准备重点实施增量适配与删除策略改造。对于不具备增量条件且需要增量导出的表，需新增更新时间戳字段，并通过触发器或应用逻辑确保其更新。针对数据删除场景，原则上优先采用逻辑删除；对于必须保留物理删除的表，需建立辅助日志表，确保接收端能同步处理所有变更。
数据表首次上线时，需按照接口规范导出历史全量数据TXT文件作为基线数据，历史数据文件需与日常增量数据文件采用相同的格式规范。
（二）数据卸载
数据卸载以任务方式进行，每个任务包括任务管理、数据抽取、压缩以及安全处理。
数据卸载任务应在业务低峰期（非工作时间）通过调度工具自动触发卸载任务。各业务系统需维护配置信息，包括数据源信息、需卸载的表清单、抽取策略（全量或增量）、并发度（数据库实例级别）、失败重试策略、加密密钥、执行时间、执行日历规则等运行参数。每个任务可处理抽取多张表，由各项目组自行安排。
数据抽取基于人大金仓 COPY命令，生成符合接口规范的 TXT文件。为避免对数据库造成过大压力，抽取任务需控制单数据库实例的并发数，并将单次卸载时间控制在阈值内，同时记录任务执行状态用于防止重复执行和状态追踪。各项目组需编写增量抽取的 SQL 语句。
数据抽取完成后进入压缩阶段。每个任务内的所有源文件汇总至统一的工作目录，经表清单完整性检查后进行压缩处理。任务启动时生成全局唯一批次号。任务执行完成后，形成一个压缩文件，并进行分片。压缩文件名称带批次号。批次号格式为“{yyyyMMddHHmmss}_{流水号}”，其中时间戳精确到秒，流水号首次执行为 001，补数时依次递增。当压缩后体积超过分片阈值时，按阈值进行分片压缩，生成“{系统名称}_{批次号}.tar.gz.001”、“{系统名称}_{批次号}.tar.gz.002”等分片文件，分片阈值需根据刻盘容量设置。
最后是安全处理阶段，为确保数据传输的机密性与完整性，将采用国密算法进行安全处理。对压缩后的文件或分片使用 SM3 算法计算文件摘要值，进行 SM4 加密，并生成“{系统名称}_{批次号}.manifest.json”记录文件清单、文件大小、摘要值、生成时间等信息。
（三）数据导出
各业务系统数据卸载完成后，经刻盘实现跨网数据传输后，数据交换至目标端，即证联网一库接口服务器。
为确保数据在全链路中的可追溯性，建立统一的目录命名标准。各业务系统需遵循统一规则、按日分批的导出原则。原则上，数据交换源端（会内）路径规划为/mnt/bigdisk/DES/NSIT_SEND/csdata/{业务系统简称}，目标端（证联网）路径规划为/mnt/nas/recv/数据源单位缩写/租户名/FROM_实际来源单位缩写_下游系统缩写/，具体实施路径以最终商定为准。
（四）数据入库
数据到达一库接口服务器后，需先完成数据解密和校验、分片合并和解压，随后通过 DataWorks 数据迁移工具按天将 TXT 文件同步至一库 MaxCompute。在入库加载环节，实施数据融合策略，确保增量数据能够覆盖历史数据，保持数据的最新状态。
入库前需检查批次号是否已处理，防止重复入库。
对于采用增量抽取的表，系统根据业务主键或唯一标识字段，将当日增量数据与历史数据进行合并。当主键冲突时，以最新批次号的数据为准，新数据覆盖旧数据，实现数据的按天更新。对于采用全量抽取的表，则直接用最新全量数据替换历史数据。
（五）容错和运维机制
针对异常情况，卸载程序需内置自动重试机制。单表卸载失败不影响其他表的执行。自动重试后仍然失败的任务，可通过运维巡检发现后，转由人工介入进行问题排查和任务补数。
为确保数据可追溯，数据交换区文件需保留一定周期，便于问题排查和数据重传。在传输和入库环节，如发生传输延迟，由信息中心运维人员说明原因及预计恢复时间。对于摘要校验不一致、解密失败、数据格式错误等问题，可优先从证联网数据交换区重新处理。如经排查需重新生成数据文件，需协同信息中心运维人员，由会内网重新卸载并刻盘传输。如遇到"一库"入库任务失败，可由"一库"运维人员协同中证数据团队定位问题后重新入库。
计划安排
（一）职责分工
中证数据负责制定接口规范，以及数据入一库功能开发、上线。
中证技术负责技术开发，将相关系统的数据按照接口规范生成文件。
信息中心运维人员负责每日将数据文件导出至证联网对应目录，保证数据导出通道的正常运行。
（二）工作计划
工作计划主要分为两个部分，一是中证数据明确入库范围并制定接口规范，中证技术配合梳理相关信息，结合内网数据情况制定各项目实施计划，完成导出数据标识的改造和卸载；二是数据入库工作的两网联调实施。
各项目组需要按本方案制定各自实施计划，根据实际情况，拟按批次开展内网系统入库。选取机构系统、诚信系统、私募系统等3个目前具备可实施条件的系统作为第一批入库系统，优先按照下述计划开展相关工作，上市系统、发行系统、会计系统、投保系统、外网门户系统、支撑系统等其他系统作为第二批次参照下述时间安排计划开展入库工作。
序号	工作内容	时间安排(工作日)	负责方
一 各项目实施计划
1	信息中心及科技司审批通过	T日	
2	数据盘点，确定入库数据清单和入库方式，制定接口规范	T+35日	中证数据、
中证技术开发部、测试部、大数据部
3	增量导出改造和数据卸载开发、上线和联调	T+60日（项目组可结合实际情况适当调整）	中证技术开发部、测试部、大数据部、
信息中心运行处
二 入库实施两网联调计划
1	两网数据联调的入库开发、测试和上线	T+90日	中证数据
中证技术开发部、测试、大数据部
2	定期评估和调整入库范围及接口规范	持续	中证数据
中证技术开发部、测试部、大数据部





附件2-1：会内网各监管业务系统入库表数量
系统名称	模块名称	表数量	支撑增量导出表数量	可通过改造实现增量导出表数量
上市系统	上市日常监管模块	344	236	108
诚信与法规系统	诚信档案数据库模块	32	32	
发行系统	发行监管信息模块	49	49	
会计系统	会管单位财务管理信息模块	143	133	10
机构系统	机构监管模块	56	48	8
私募系统	私募基金监管	11	11	
投保系统	投保监管	102	102	
外网门户	行政许可	46	46	
	依申请公开	8	8	
支撑系统	监管引擎	26	26	
	通知公告	6	6	
合计	823	697	126

附件2-2：会内网各监管业务系统入库表详情