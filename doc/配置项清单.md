# 配置项清单

本文档列举 KEL 配置的完整项清单，按新的结构组织。

## 配置结构

```yaml
# ==========================================
# 1. 基础信息
# ==========================================
job:
  type: "EXTRACT_KINGBASE"     # 作业类型：EXTRACT_KINGBASE | FILE_EXTRACT | KINGBASE_LOAD | FILE_LOAD
  name: "daily_sync"           # 作业名（全局唯一标识）
  description: "每日数据同步"   # 作业描述

# ==========================================
# 2. 全局配置 (Settings)
# ==========================================
settings:
  # --- 基础运行参数 ---
  runtime:
    table_concurrency: 4         # 表级并发数，默认 3
    max_retries: 3               # 失败重试次数，默认 3
    retry_interval_sec: 5        # 重试间隔（秒），默认 5

  # --- 数据格式通用配置 ---
  encoding: "UTF-8"                    # 文件编码，默认 UTF-8
  batch_number_format: "yyyyMMdd_NNN"  # 批次号格式，默认 yyyyMMdd_NNN
  cleanup_work_dir: true               # 执行后清理工作目录，默认 true（暂不实现）

  # --- 压缩配置 ---
  compression:
    enable: true                # 是否启用压缩，默认 true
    algorithm: "gzip"           # 压缩算法，默认 gzip
    split_threshold_gb: 2       # 文件拆分阈值（GB），默认 2

  # --- 加密配置 ---
  security:
    enable: true                # 是否启用加密，默认 false
    sm4_key: "csits@2026"       # SM4 加密密钥

  # --- 磁盘保护（预留字段，暂不实现）---
  disk_protection:
    enabled: true                   # 是否启用磁盘保护，默认 true
    min_free_space_gb: 10           # 最小剩余空间（GB），默认 10
    min_free_space_percent: 10      # 最小剩余空间百分比，默认 10
    fail_on_check_error: true       # 检查失败时是否中止任务，默认 true

  # --- 文件命名规范 ---
  file_naming:
    enable_standard_naming: true    # 是否启用标准命名，默认 false
    version: "V01"                  # 版本号，文件名第三段，默认 V01

# ==========================================
# 3. 资源配置 (Resources)
# ==========================================
resources:
  # --- 卸载源数据库配置（卸载任务时必填）---
  extract_database:
    host: "localhost"           # 数据库主机
    port: 54321                 # 数据库端口
    name: "source_db"           # 数据库名
    user: "reader"              # 数据库用户
    password: "password"        # 数据库密码
    database_version: "V8R6"    # 数据库版本

  # --- 加载目标数据库配置（加载任务时必填）---
  target_database:
    host: "localhost"           # 数据库主机
    port: 54321                 # 数据库端口
    name: "target_db"           # 数据库名
    user: "writer"              # 数据库用户
    password: "password"        # 数据库密码
    database_version: "V8R6"    # 数据库版本

  # --- 路径配置 ---
  paths:
    work_dir: "../data/work"            # 工作目录，必填
    exchange_dir: "../data/exchange"    # 数据交换目录（可选）
    input_dir: "../data/input"          # 加载输入目录（加载时必填）
    extract_dir: "../data/extract"      # 卸载输出目录（卸载时必填）
    target_dir: "../data/target"        # 文件加载目标目录（文件加载时必填）

# ==========================================
# 4. 任务流水线 (Tasks)
# ==========================================
tasks:
  # 场景1：全量表卸载
  - mode: "FULL"                        # 模式：FULL | INCREMENTAL
    tables:                             # 表列表（与 queries、files 互斥）
      - "t_bond_info"
      - "t_bond_trade"
    interface_mapping:                  # 可选，表名→接口编码映射
      t_bond_info: "J0001"

  # 场景2：增量 SQL 卸载
  - mode: "INCREMENTAL"
    queries:                            # SQL 查询列表（与 tables、files 互斥）
      - name: "company_info_inc"
        sql: "SELECT * FROM t_company_info WHERE update_time >= CURRENT_DATE"
    interface_mapping:                  # SQL 名→接口编码映射
      company_info_inc: "J0001"

  # 场景3：文件采集
  - mode: "INCREMENTAL"
    files:                              # 文件采集配置（与 tables、queries 互斥）
      pattern: "*.pdf"                  # 文件匹配模式
      time_type: "MODIFY_TIME"          # 时间类型：CREATE_TIME | MODIFY_TIME
      time_range: "LAST_1_DAY"          # 时间范围：LAST_N_DAY | LAST_N_HOUR
      size_limit_mb: 500                # 单文件大小限制（MB）

  # 场景4：清空加载
  - mode: "TRUNCATE_LOAD"               # 模式：TRUNCATE_LOAD | MERGE | APPEND
    mappings:                           # 接口编码→目标表映射
      "J0001": "t_bond_info"
    transaction: true                   # 是否启用事务，默认 true

  # 场景5：合并加载
  - mode: "MERGE"
    mappings:                           # 接口编码→临时表映射
      "J0001": "t_bond_info_back"
    merge_sql: |                        # 合并 SQL
      DELETE FROM t_bond_trade WHERE trade_id IN (SELECT trade_id FROM t_bond_info_back);
      INSERT INTO t_bond_trade SELECT * FROM t_bond_info_back;
    transaction: true

  # 场景6：文件追加加载
  - mode: "APPEND"
    target_dir: "/data/archive"         # 目标目录
```

## 配置说明

### 1. 任务模式 (mode)

**卸载模式：**
- `FULL`：全量卸载
- `INCREMENTAL`：增量卸载

**加载模式：**
- `TRUNCATE_LOAD`：清空目标表后加载
- `MERGE`：先加载到临时表，再通过 SQL 合并到目标表
- `APPEND`：追加加载（文件直接复制到目标目录）

### 2. 字段互斥关系

**任务类型由字段确定（三选一）：**
- `tables`：表列表，用于表级卸载
- `queries`：SQL 查询列表，用于 SQL 级卸载
- `files`：文件采集配置，用于文件采集

### 3. interface_mapping 说明

**卸载时：** 表名/SQL名 → 接口编码
- 用于生成标准文件名（如 `SYS_J0001_V01_20260130_001_Q.TXT`）

**加载时：** 接口编码 → 目标表名/临时表名
- 用于识别文件并加载到对应表

### 4. 路径流程

```
卸载流程：extract_database → work_dir → extract_dir → [exchange_dir]
加载流程：[exchange_dir] → input_dir → work_dir → target_database/target_dir
```

### 5. 配置复用与覆盖

- `settings` 中的配置为全局默认值，适用于所有作业
- 作业配置中可覆盖 `settings` 中的任意配置项
- `resources` 中的数据库和路径配置通常在作业级定义

### 6. 完整示例

参见 `kel/配置项清单.yaml` 文件中的详细示例。
