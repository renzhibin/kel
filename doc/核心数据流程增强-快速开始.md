# 核心数据流程增强 - 快速开始指南

## 前置条件

1. Java 8+
2. Maven 3.6+
3. PostgreSQL/Kingbase数据库（用于测试）
4. XXL-Job调度中心（可选）

## 快速测试

### 1. 编译项目

```bash
cd kel
mvn clean package -DskipTests
```

### 2. 配置测试数据库

编辑 `kel/kel-start/src/main/resources/conf/dev/jobs/demo_extract.yaml`：

```yaml
job:
  type: "EXTRACT_KINGBASE"
  name: "demo"
  description: "demo 作业"
extract_database:
  host: "127.0.0.1"
  port: 5432
  name: "postgres"
  user: "postgres"
  password: "your_password"
work_dir: "work"
exchange_dir: "exchange"
extract_tasks:
  - type: "FULL"
    tables:
      - "pg_catalog.pg_tables"
runtime:
  table_concurrency: 1
```

### 3. 启用国密加密（可选）

编辑 `kel/kel-start/src/main/resources/application.yml`：

```yaml
spring:
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration

server:
  port: 8081

kel:
  conf:
    base-dir: classpath:conf/dev
  crypto:
    provider: bouncycastle  # 使用真实国密算法
  security:
    enable_encryption: true  # 启用加密
    sm4_key: "test_key_123456"  # 16字节密钥

xxl:
  job:
    accessToken: default_token
    admin:
      addresses: http://localhost:8080/xxl-job-admin
    executor:
      appname: kel-executor
      address:
      ip:
      port: 9999
      logpath: logs/xxl-job/jobhandler
      logretentiondays: 30
```

### 4. 测试数据卸载

```bash
cd kel/kel-start
java -jar target/kel-start-0.0.1-SNAPSHOT.jar --jobCode=demo
```

**预期输出：**
```
连接数据库 url=jdbc:postgresql://127.0.0.1:5432/postgres, user=postgres
导出表 pg_catalog.pg_tables 完成，共 150 行（使用COPY TO STDOUT）
数据库卸载完成，共导出 1 个表/查询
生成manifest，包含 1 个数据文件
Manifest已写入: work/demo/20260129153000_001/manifest.json
压缩与分片完成
文件已加密: demo_20260129153000_001.tar.gz
卸载任务完成
```

### 5. 检查生成的文件

```bash
# 查看工作目录
ls -lh work/demo/20260129153000_001/

# 查看manifest.json
cat work/demo/20260129153000_001/manifest.json

# 查看交换目录（加密后的文件）
ls -lh exchange/demo/20260129153000_001/
```

**目录结构：**
```
work/demo/20260129153000_001/
├── data/
│   └── pg_catalog_pg_tables.txt  # 导出的数据
└── manifest.json                  # 元数据文件

exchange/demo/20260129153000_001/
└── demo_20260129153000_001.tar.gz  # 加密的压缩包
```

### 6. 测试数据加载

创建加载配置 `kel/kel-start/src/main/resources/conf/dev/jobs/demo_load.yaml`：

```yaml
job:
  type: "KINGBASE_LOAD"
  name: "demo_load"
  description: "demo 加载作业"
target_database:
  host: "127.0.0.1"
  port: 5432
  name: "postgres"
  user: "postgres"
  password: "your_password"
work_dir: "work"
input_directory: "exchange/demo/20260129153000_001"
load_tasks:
  - type: "TRUNCATE_LOAD"
    interface_mapping:
      pg_catalog_pg_tables: "public.test_table"
    enable_transaction: true
```

执行加载：

```bash
java -jar target/kel-start-0.0.1-SNAPSHOT.jar --jobCode=demo_load
```

**预期输出：**
```
文件已解密: demo_20260129153000_001.tar.gz
未找到分片文件，直接解压主文件
解压完成
解析manifest: jobCode=demo, batchNumber=20260129153000_001, files=1
文件校验通过: data/pg_catalog_pg_tables.txt
Manifest校验通过，所有文件完整
已加载 pg_catalog_pg_tables.txt -> public.test_table
加载任务完成
```

## 功能验证清单

### ✅ COPY TO STDOUT导出
- [ ] 查看日志确认使用"COPY TO STDOUT"
- [ ] 如果失败，确认是否自动fallback到"COPY TO文件"
- [ ] 对比导出速度（应该比SELECT快很多）

### ✅ 国密算法
- [ ] 启用加密后，exchange目录的文件无法直接解压
- [ ] 使用错误密钥加载会失败
- [ ] 查看manifest.json中的SM3校验和

### ✅ Manifest元数据
- [ ] manifest.json包含文件清单
- [ ] 每个文件都有size和sm3字段
- [ ] 加载时会校验文件完整性

### ✅ 分片合并
- [ ] 修改`split_threshold_gb: 0.001`（1MB）触发分片
- [ ] 查看exchange目录生成.001, .002等分片文件
- [ ] 加载时自动合并分片

### ✅ 端到端加密
- [ ] 卸载时文件被加密
- [ ] 加载时自动解密
- [ ] 修改加密文件后，manifest校验失败

## 性能测试

### 测试COPY vs SELECT性能

**修改KingbaseExtractPlugin临时禁用COPY：**
```java
// 注释掉COPY TO STDOUT，使用旧的SELECT方式
// long rowCount = exportTableWithCopyToStdout(conn, table, file);
```

**对比导出时间：**
- SELECT方式：约X秒
- COPY方式：约Y秒
- 性能提升：X/Y倍

### 测试大文件加密性能

```bash
# 创建10MB测试文件
dd if=/dev/urandom of=test_10mb.bin bs=1M count=10

# 测试加密时间
time java -cp kel-manager.jar \
  org.csits.kel.manager.security.BouncyCastleSmCryptoManager \
  encrypt test_10mb.bin test_10mb.enc "test_key"
```

## 故障排查

### 问题1：COPY TO STDOUT失败

**错误信息：**
```
COPY TO STDOUT失败，尝试COPY TO文件: permission denied
```

**解决方案：**
- 这是正常的fallback行为
- 确认数据库用户有文件写权限
- 或者接受使用COPY TO STDOUT方式（推荐）

### 问题2：Manifest校验失败

**错误信息：**
```
SM3校验和不匹配: data/xxx.txt
```

**解决方案：**
- 文件在传输过程中被修改
- 检查文件完整性
- 重新执行卸载任务

### 问题3：解密失败

**错误信息：**
```
SM4解密失败: xxx.tar.gz
```

**解决方案：**
- 确认加载配置中的sm4_key与卸载时一致
- 检查文件是否被损坏
- 确认文件确实是加密的

### 问题4：分片合并失败

**错误信息：**
```
未找到压缩包或分片文件
```

**解决方案：**
- 确认input_directory路径正确
- 检查分片文件命名是否符合.001, .002格式
- 确认所有分片文件都存在

## 配置参考

### 完整的global.yaml配置

```yaml
concurrency:
  default_table_concurrency: 2
retry:
  max_retries: 1
  retry_interval_sec: 60
compression:
  algorithm: "gzip"
  split_threshold_gb: 3.5  # 超过3.5GB自动分片
enable_compression: true
security:
  sm4_key: "your_16byte_key"
  enable_encryption: false  # 默认关闭加密
extract:
  work_dir: "work"
  batch_number_format: "{yyyyMMddHHmmss}_{seq}"
  encoding: "UTF-8"
  database_version: "V8R6"
  cleanup_work_dir: false
```

### 完整的application.yml配置

```yaml
spring:
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration

server:
  port: 8081

kel:
  conf:
    base-dir: classpath:conf/dev
  crypto:
    provider: bouncycastle  # bouncycastle或simple
    buffer_size: 8192       # 加密缓冲区大小

xxl:
  job:
    accessToken: default_token
    admin:
      addresses: http://localhost:8080/xxl-job-admin
    executor:
      appname: kel-executor
      port: 9999
      logpath: logs/xxl-job/jobhandler
      logretentiondays: 30
```

## 下一步

1. **集成测试**：编写完整的端到端测试
2. **并发导出**：实现HikariCP连接池并发导出多表
3. **性能调优**：测试不同并发度和缓冲区大小
4. **生产部署**：配置真实的Kingbase数据库和XXL-Job

## 技术支持

如遇到问题，请检查：
1. 日志文件：`logs/xxl-job/jobhandler/`
2. 工作目录：`work/`
3. 交换目录：`exchange/`
4. Manifest文件：`work/<jobName>/<batchNumber>/manifest.json`
