# 人大金仓卸载加载工具功能实现对照与开发计划

> 参考文档：  
> - 《人大金仓数据卸载加载技术方案 v0.11》  
> - 《监督平台数据同步工作计划.xlsx》（同步工具开发自测部分：公共模块、执行节点-卸载/加载、管控中心）  
> - 当前代码：`kel-*` 多模块工程  
> - 《人大金仓卸载加载工具-未实现功能清单.md`

本文从“**要做什么**（方案+工作计划）”到“**现在做了什么**（代码）”做一一对照，并给出**后续开发建议与优先级**，方便你排期和跟踪。

---

## 1. 公共模块（配置 / MANIFEST / 压缩加密等）

### 1.1 配置管理模块（YAML 解析、校验、合并）

- **需求来源**
  - 方案文档 3.2（全局配置、作业配置）、4.1、6.5
  - 工作计划行：“配置管理模块（YAML 解析、配置校验、配置合并等）”
- **当前实现**
  - `GlobalConfig`、`JobConfig` DTO 完成。
  - `YamlConfigLoader` 负责从 `Resource` 读取并映射为 DTO。
  - `JobConfigService` 已实现：
    - 按 `jobCode` + `extract/load` 加载 YAML。
    - 合并 `runtime.table_concurrency` → 覆盖全局并发配置。
  - 单元测试：`YamlConfigLoaderTest`、`JobConfigServiceTest`。
- **缺口**
  - YAML 语义校验（必填项、取值范围、目录存在性等）缺失。
  - 多环境（dev/test/prod）配置管理、冷/热加载策略未实现。
  - 配置中心（Nacos 等）集成缺失。
- **建议优先级**：**P1**（配置是所有能力的前置）。

### 1.2 MANIFEST 接口类与实现

- **需求来源**
  - 方案文档 3.3.4、3.4.5（manifest.json 结构与内容）
  - 工作计划行：“MANIFEST 接口类”
- **当前实现**
  - 无对应 Java 模型类、无生成/解析逻辑。
- **建议实现方向**
  - 定义 `Manifest` DTO（basic_info / file_list / compression_info / structured_data_info / unstructured_files_info）。
  - 在 `TaskExecutionService.executeExtract` 的后处理阶段：
    - 汇总结构化/非结构化导出结果 + 压缩分片信息。
    - 生成 `{jobName}_{batchNumber}.manifest.json` 写入 exchange 目录。
  - 在 `executeLoad` 前置阶段：
    - 解析 manifest，驱动后续解包、加载与校验流程。
- **建议优先级**：**P1**（后续安全与加载流程都依赖 manifest）。

### 1.3 Kingbase 数据库驱动兼容（版本识别、连接池配置）

- **需求来源**
  - 方案文档 3.2.3（Kingbase 卸载）、7（技术风险）
  - 工作计划行：“人大金仓数据库驱动兼容（V8R6/V8R3 驱动集成、版本识别、连接池配置）”
- **当前实现**
  - `KingbaseExtractPlugin` / `KingbaseLoadPlugin` 使用 PostgreSQL 驱动占位（`org.postgresql`）。
  - `JobConfig.ExtractDatabaseConfig` / `TargetDatabaseConfig` 已包含 `version` 字段。
- **缺口**
  - 未引入真实 Kingbase 驱动（或兼容层）。
  - 未根据 `version` 做驱动选择和 SQL 差异适配。
  - 未有连接池配置（Hikari 等）。
- **建议优先级**：**P1**（真机环境落地前必须解决）。

### 1.4 COPY 命令执行器与自动降级

- **需求来源**
  - 方案文档 4.2.2、6.4
  - 工作计划行：“COPY 命令执行器类（兼容 copy 和重定向方式，实现自动降级）”
- **当前实现**
  - `KingbaseExtractPlugin` 使用 `SELECT *` + 手工写 TXT，不使用 COPY。
- **缺口**
  - 缺少统一的 `CopyExecutor` 抽象：
    - 优先尝试数据库端 `COPY ... TO STDOUT`。
    - 无法使用时自动降级为客户端流式导出。
- **建议优先级**：**P2**（功能可以先用当前实现跑通，性能优化时必做）。

### 1.5 国密算法模块（SM3/SM4）

- **需求来源**
  - 方案文档 3.4.4、3.4.5
  - 工作计划行：“国密算法模块（SM3/SM4 实现、密钥管理）”
- **当前实现**
  - `SmCryptoManager` 接口。
  - `SimpleSmCryptoManager` 用 SHA-256 + 文件复制占位。
  - 主流程中尚未调用 SM3/SM4，仅在工具层做准备。
- **缺口**
  - 未接入真正的国密库（JCE Provider 或第三方库）。
  - 未设计密钥管理（读取 `GlobalConfig.SecurityConfig`、轮换策略等）。
  - 未在压缩/分片后实际执行摘要与加密。
- **建议优先级**：**P1**（如果要进生产环境，安全必须补齐）。

### 1.6 压缩与分片模块（TAR 打包、GZIP 压缩、分片）

- **需求来源**
  - 方案文档 3.3.2、3.3.4、4.2.3
  - 工作计划行：“压缩与分片模块（TAR 打包、GZIP 压缩、文件分片、分片合并）”
- **当前实现**
  - `LocalCompressionManager`：
    - `compressToTarGz`：打包 + gzip。
    - `split`：按阈值简单分片。
    - `decompressTarGz`：解压并防止目录穿越。
  - `TaskExecutionService`：
    - 卸载时调用 `compressToTarGz` + `split`。
    - 加载时只解压主 `.tar.gz`，未处理 `.001/.002...`。
- **缺口**
  - 分片合并逻辑（LOAD 前需要先合并再解压）。
  - 与 manifest 中分片信息的校验联动。
  - 大文件场景下的错误恢复与断点续传策略未设计。
- **建议优先级**：**P2**（功能可用，但与 manifest/安全联动后需整体补强）。

---

## 2. 执行节点 - 卸载侧

### 2.1 非结构化文件采集（扫描 + 过滤）

- **需求来源**
  - 方案文档 3.2.3（FILE_EXTRACT 示例）、4.2.2
  - 工作计划行：“非结构化文件递归扫描与时间窗口筛选”
- **当前实现**
  - `FileExtractPlugin` + `LocalFileSystemManager.scanFiles`：
    - 递归扫描目录。
    - 按 glob pattern 匹配文件。
    - 支持按时间窗口（`LAST_N_DAY`）和大小上限过滤。
    - 复制到 `{work_dir}/{job}/{batch}/files/`。
- **缺口**
  - 更复杂的采集模式（例如“表关联”）未实现。
  - 采集结果未写入 manifest 或元数据存储。
- **建议优先级**：**P2**。

### 2.2 JDBC 重定义写入机制 / 增量量

- **需求来源**
  - 工作计划行：“JDBC 重定义写入机制，增全量”
  - 对应方案文档中对 FULL / INCREMENTAL 抽取与 SQL 列表的设计。
- **当前实现**
  - `JobConfig.ExtractTaskConfig` 支持 FULL / INCREMENTAL、`tables` 和 `sqlList`。
  - `KingbaseExtractPlugin`：
    - 对 FULL: `SELECT * FROM table`。
    - 对 INCREMENTAL: 按配置的 SQL 执行并写入 TXT。
- **缺口**
  - 未抽象出统一的“增全量执行器”，区分：
    - 基于主键/时间戳的增量策略。
    - 基于 SQL 的自定义增量。
  - 未做增量边界记录与重复执行防护。
- **建议优先级**：**P2**。

### 2.3 文件处理工具类（命名生成器、批次号生成器、目录结构、文件复制）

- **需求来源**
  - 方案文档 3.3.2、3.3.4、3.3.3
  - 工作计划行：“文件处理工具类（命名生成器、批次号生成器、目录结构、文件复制）”
- **当前实现**
  - `BatchNumberGenerator` 已实现批次号 `{yyyyMMddHHmmss}_{seq}`。
  - `LocalFileSystemManager` 封装了目录创建、复制、移动、扫描。
  - 目录结构基本遵循 `{work}/{job}/{batch}/data`、`files`。
- **缺口**
  - 标准文件命名规范（如 `BSS_J0001_V01_20260119_001_Q.TXT`）未真正实现。
  - 接口编码映射（表名/任务名 → J0001 等）未用于命名。
  - 仅有批次号生成器，缺少统一的“文件名生成器”工具。
- **建议优先级**：**P2**。

### 2.4 压缩加密、元数据记录

- **需求来源**
  - 方案文档 3.3.2、3.4.4、3.4.5
  - 工作计划行：“压缩加密等”、“元数据记录（表名/记录数/文件大小/文件路径/状态）”
- **当前实现**
  - 压缩与分片见 1.6。
  - 没有结构化的元数据记录模型（只在日志中简单打印）。
- **缺口**
  - 表级/文件级元数据的统一存储（数据库表或 manifest）。
  - 加密与摘要流程未串联到卸载主流程中。
- **建议优先级**：**P1.5**（介于 P1/P2 之间，和 manifest 一起设计较好）。

---

## 3. 执行节点 - 加载侧

### 3.1 数据包解析与元数据校验

- **需求来源**
  - 工作计划行：“数据包解析”、“元数据校验”
  - 方案文档 4.3.1、3.4.5。
- **当前实现**
  - `TaskExecutionService.unpackToWorkDir` 只做：
    - 找到主 `.tar.gz`。
    - 解压到工作目录。
  - 未读取 manifest，也未做任何元数据比对。
- **缺口**
  - 分片合并与解压前的完整性校验。
  - manifest 驱动的文件/表级检查。
- **建议优先级**：**P1**。

### 3.2 结构化数据加载（TRUNCATE_LOAD / APPEND / MERGE）

- **需求来源**
  - 工作计划行：“结构化数据加载 TRUNCATE_LOAD、APPEND、MERGE”
  - 方案文档 3.2.4、4.3.2。
- **当前实现**
  - `KingbaseLoadPlugin`：
    - 对每个 `LoadTaskConfig`：
      - 根据 `LoadMode` 决定 TRUNCATE_LOAD / APPEND / MERGE。
      - 支持配置事务开启与回滚。
      - 支持额外 SQL 列表执行（可用于 MERGE）。
- **缺口**
  - 未与 manifest 强绑定（当前依赖文件名推断）。
  - 没有对记录数/文件大小做加载前/后的核对。
- **建议优先级**：**P2**。

### 3.3 非结构化文件恢复

- **需求来源**
  - 工作计划行：“非结构化数据恢复”
  - 方案文档 4.3.3。
- **当前实现**
  - `FileLoadPlugin`：从 `{work}/{job}/{batch}/files` 复制到 `target_directory`。
- **缺口**
  - 未基于 manifest 做精确控制和校验。
  - 未处理覆盖策略、权限、时间戳等运维细节。
- **建议优先级**：**P2**。

---

## 4. 管控中心（Web 管理 & 运维）

### 4.1 作业配置管理 / 导出 / 数据源测试 / 规则测试

- **需求来源**
  - 工作计划表中“管控中心”部分：
    - 作业配置管理接口
    - 导出功能
    - 数据源连接测试接口
    - 结构化/非结构化规则测试接口（文件列表预览）
  - 方案文档 5.1。
- **当前实现**
  - `kel-web` 仅有 `/api/health`、`/api/git`。
- **缺口**
  - 上述所有后端接口与前端页面均未实现。
- **建议优先级**：**P1 对业务方可见功能**（可以分阶段实现：先实现配置查看/导出与连接测试，再逐步补充规则测试）。

### 4.2 任务查询 / 脚本执行 / 运维统计

- **需求来源**
  - 工作计划表 & 方案文档 5.1.3、5.1.4。
- **当前实现**
  - 无对应接口。
  - 仅 `TaskLogger` 负责更新进度到内存仓储。
- **缺口**
  - 任务列表、详情、日志摘要、manifest 查看、脚本执行记录等。
- **建议优先级**：**P2**（在任务持久化和 manifest 补齐后推进）。

### 4.3 前端开发与前后端联调

- **需求来源**
  - 工作计划行：“前端开发”、“前后端联调”。
- **当前实现**
  - 无前端工程，仅后端 demo Controller。
- **建议优先级**：取决于外部依赖，可与后端接口按迭代并行推进。

---

## 5. 推荐实施顺序（高层）

结合 v0.11 方案与“同步工具开发自测”计划，建议的整体顺序：

1. **打牢公共模块**
   - 完成 manifest 模型、生成与解析（P1）。
   - 串联 SM3/SM4 占位实现到卸载/加载流水线（P1，可先用非国密实现跑通流程）。
   - 补齐压缩+分片+合并与 manifest 的联动（P1/P2）。
2. **补齐执行节点核心能力**
   - 结构化卸载/加载：
     - 抽象 CopyExecutor，渐进引入 COPY 命令（P2）。
     - 与 Kingbase 驱动集成及版本兼容（P1）。
   - 非结构化采集/恢复：在现有插件基础上接入 manifest 与元数据统计（P2）。
3. **任务持久化与监控**
   - 引入真正的 `task_execution` 数据表与 DAO 实现（P1）。
   - TaskLogger / TaskExecutionService 与 DB/manifest 打通。
4. **管控中心与前端**
   - 先实现基础查询接口（作业配置、任务列表、任务详情）。
   - 再迭代脚本执行、日志下载、规则测试、运维统计。
5. **XXL-JOB 集成**
   - 在功能基本稳定后，编写对应 JobHandler，实现调度中心接入与统一运维。

---

如你希望，我可以基于这份对照再拆一份按 **迭代（Sprint）** 维度划分的更细化开发计划，每个迭代列出具体类/接口与验收标准。 

