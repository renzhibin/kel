# KEL 配置设计说明：全局与作业

本文档约定全局配置（global.yaml）与作业配置（各 job 的 YAML）的**文件名与目录、参数项、命名和层级关系**，便于后续实现合并逻辑时一致。

---

## 一、配置文件命名与目录（参考知名产品）

### 1.1 知名产品约定

| 产品 | 全局配置 | 作业/任务级配置 | 说明 |
|------|----------|-----------------|------|
| **Airflow** | 单文件 `airflow.cfg`（INI），位于 AIRFLOW_HOME；也可用环境变量 | `[core]dags_folder` 指向目录（默认 `AIRFLOW_HOME/dags`），每个 DAG 一个 Python 文件，文件名即代码内 DAG 名，无统一后缀 | 全局单文件 + 作业即「目录下多文件」，作业无统一文件名模式 |
| **Jenkins** | 根目录单文件 `config.xml`（JENKINS_HOME/config.xml） | 每个作业一个目录 `jobs/<JobName>/config.xml`，作业名即目录名，配置统一叫 `config.xml` | 全局单文件；作业按「目录名」区分，目录内固定 `config.xml` |
| **XXL-Job** | Spring 应用：`application.properties` 或 `application-{profile}.yml` | 任务定义存数据库（xxl_job_info），无「作业配置文件」；多环境用 profile 区分（如 application-dev.yml） | 全局即应用配置；作业在 DB，无文件命名约定 |

共同点：**全局均为单文件、固定或约定俗成的文件名**；作业侧要么按「目录/文件」区分（Airflow 按文件、Jenkins 按目录名），要么在 DB（XXL-Job）。

### 1.2 KEL 约定

| 类型 | 文件名 | 目录 | 说明 |
|------|--------|------|------|
| **全局** | `global.yaml` | 存 DB 时键为 `__global__`；文件形态时在 `conf/<profile>/` | 单文件；由 `kel.conf.base-dir` 指定 base（如 classpath:conf/dev）。运行时从 DB 读取。 |
| **作业** | 作业名（job.name）全局唯一，如 `bss_kingbase_extract` | 存 DB；文件形态时在 `conf/<profile>/jobs/`，文件名即作业名 + `.yaml` | 不靠文件名后缀区分类型，靠 YAML 内 `job.type` 区分。 |

---

## 二、设计原则

1. **全局配置**：环境级默认值，所有作业共享；与具体库、具体任务无关的通用项放在全局。
2. **作业配置**：本作业独有或对全局的覆盖；连接信息、任务定义等必须 per-job。
3. **命名与层级**：同一语义的项在全局和作业中尽量同名或成对（如全局默认 vs 作业覆盖），层级上能对应则对应，避免「名字像但不知道会不会合并」。

---

## 三、当前结构简要

| 层级 | 全局 (global) | 作业 (job) |
|------|----------------|------------|
| 顶层 | concurrency, retry, compression, security, extract, file_naming, disk_protection | job, extract_database, target_database, work_dir, input_directory, extract_tasks, load_tasks, runtime |
| 问题 | extract 下有 work_dir, batch_number_format, encoding, **database_version** | extract_database 下有 host, port, name, user, password, **version**；二者无明确对应关系 |

当前实现里，**全局的 extract.database_version 与作业的 extract_database 不做合并**，两棵树分开用。若希望「作业不填 version 时用全局 database_version」，需要在设计里显式约定并在实现里做合并。

---

## 四、建议的配置项与命名

### 4.1 全局配置（global）

建议保持「按功能块」分组的扁平结构，YAML 用 snake_case：

| 块 | 参数名 | 含义 | 备注 |
|----|--------|------|------|
| **extract** | work_dir | 工作目录 | 卸载/加载共用工作根 |
| | batch_number_format | 批次号格式 | 如 {yyyyMMdd}_{seq} |
| | encoding | 文件编码 | 如 UTF-8 |
| | database_version | 数据库版本默认值 | 如 V8R6，供作业中不填时使用 |
| | cleanup_work_dir | 完成后是否清理工作目录 | |
| **concurrency** | default_table_concurrency | 默认表级并发数 | |
| **retry** | max_retries, retry_interval_sec | 重试次数与间隔 | |
| **compression** | algorithm, split_threshold_gb | 压缩算法与分片阈值 | |
| **security** | sm4_key, enable_encryption | 加密相关 | |
| **file_naming** | （现有） | 文件命名规则 | |
| **disk_protection** | enabled, min_free_space_gb 等 | 磁盘保护 | |

要点：全局与作业**同名** **database_version**（全局 extract.database_version，作业 extract_database.database_version），语义一致，合并规则简单：作业不填则用全局。

### 4.2 作业配置（job）

作业侧分三类：**元信息、连接信息、任务与运行时**。

| 类别 | 参数名（YAML） | 含义 | 与全局的关系 |
|------|----------------|------|--------------|
| 元信息 | job.type, job.name, job.description | 作业类型与描述 | 无对应，作业独有 |
| 连接-卸载 | extract_database | 卸载库连接 | 见下 |
| 连接-加载 | target_database | 加载目标库连接 | 作业独有 |
| 路径 | work_dir, exchange_dir, input_directory, extract_directory, target_directory | 本作业路径覆盖 | 可覆盖全局 extract.work_dir 等（若实现时支持） |
| 任务 | extract_tasks, load_tasks | 表/SQL/文件任务定义 | 作业独有 |
| 运行时 | runtime.table_concurrency | 本作业并发 | 覆盖全局 default_table_concurrency（已实现） |

**extract_database / target_database 建议统一结构：**

| 参数名 | 含义 | 合并规则建议 |
|--------|------|--------------|
| host, port, name, user, password | 连接信息 | 仅作业；无全局默认 |
| database_version | 数据库版本（如 V8R6） | 作业可选；**不填时用全局 extract.database_version** |

这样「库版本」在全局与作业中**同名** **database_version**，合并规则：先看 job.extract_database.database_version，为空则用 global.extract.database_version。

### 4.3 层级对应关系（便于合并设计）

- **全局**：`extract.*` 表示「与卸载/加载流程相关的默认值」。
- **作业**：
  - `extract_database`：卸载侧**连接**（含 database_version 覆盖）。
  - `target_database`：加载侧**连接**（若将来也要库版本，可加 database_version，同样不填则用全局 extract.database_version）。
  - 不要求「全局 extract 与作业 extract_database 整块合并」，只约定：**同一语义的字段**（如 database_version）在实现合并时，作业为空则取全局对应项。

---

## 五、合并规则建议（供实现时遵守）

| 场景 | 规则 |
|------|------|
| 表级并发 | 已实现：job.runtime.table_concurrency 覆盖 global.concurrency.default_table_concurrency。 |
| 工作目录 | 已存在：job.work_dir 为空时用 global.extract.work_dir。 |
| 库版本 | 建议：job.extract_database.database_version 为空时用 global.extract.database_version；target_database 若增加 database_version 同理。 |
| 其余 | 全局与作业各读各的，不做逐项覆盖，除非后续在此文档补充。 |

合并发生时机建议：在 **loadMergedConfig 或构建 TaskExecutionContext 时** 做上述补全（只补默认值，不改变已有作业配置结构）。

---

## 六、命名与风格约定

- **YAML 键**：统一 snake_case（如 batch_number_format, extract_database, input_directory）。
- **同一概念**：全局与作业**同名**（如 database_version 在 extract 与 extract_database 中一致），并在本文档写明是否参与合并。
- **新增项**：先在本说明中登记「归属全局还是作业、是否覆盖/被覆盖」，再落代码。

---

## 七、小结

- **全局**：保留 extract.database_version 等默认值；**作业**：extract_database / target_database 中用同名 **database_version** 表示库版本，可选。
- **融合**：不做「整块按父层合并」，只对**明确约定的字段**（如 database_version、work_dir、table_concurrency）做「作业为空则用全局」的默认值补全。
- 后续若增加新的可覆盖项，在本文档「合并规则」一节补充，再实现，保证配置项与名字先设计、再编码。
