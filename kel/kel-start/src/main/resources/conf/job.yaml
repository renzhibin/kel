# ==========================================
# KEL 配置项清单
# ==========================================

# ==========================================
# 1. 基础信息
# ==========================================
job:
  type: "EXTRACT_KINGBASE"     # 作业类型：EXTRACT_KINGBASE | FILE_EXTRACT | KINGBASE_LOAD | FILE_LOAD
  name: "daily_sync"           # 作业名（全局唯一标识）
  description: "每日数据同步"   # 作业描述

# ==========================================
# 2. 全局配置 (Settings)
# ==========================================
settings:
  # --- 基础运行参数 ---
  runtime:
    table_concurrency: 4         # 表级并发数，默认 3
    max_retries: 3               # 失败重试次数，默认 3
    retry_interval_sec: 5        # 重试间隔（秒），默认 5

  # --- 数据格式通用配置 ---
  encoding: "UTF-8"                    # 文件编码，默认 UTF-8
  batch_number_format: "yyyyMMdd_NNN"  # 批次号格式，默认 yyyyMMdd_NNN

  # --- 路径配置 ---
  work_dir: "../data/work"            # 工作目录，用于数据导出、打包、压缩等中间处理，必填
  cleanup_work_dir: true               # 执行后清理工作目录，默认 true（暂不实现）

  # --- 压缩配置 ---
  compression:
    enable_compression: true                # 是否启用压缩，默认 true
    algorithm: "gzip"           # 压缩算法，默认 gzip
    split_threshold_gb: 2       # 文件拆分阈值（GB），默认 2

  # --- 加密配置 ---
  security:
    enable_encryption: true    # 是否启用加密，默认 false
    sm4_key: "csits@2026"                 # SM4 加密密钥

  # --- 磁盘保护（预留字段，暂不实现）---
  disk_protection:
    enabled: true                   # 是否启用磁盘保护，默认 true
    min_free_space_gb: 10           # 最小剩余空间（GB），默认 10
    min_free_space_percent: 10      # 最小剩余空间百分比，默认 10
    fail_on_check_error: true       # 检查失败时是否中止任务，默认 true

  # --- 文件命名规范 ---
  # 标准格式：[系统]_[接口标识]_[版本号]_[日期]_[序号]_[Q/Z].TXT
  # 未启用时用简单命名（表名.txt / sql名.txt）
  file_naming:
    enable_standard_naming: true    # 是否启用标准命名，默认 false
    version: "V01"                  # 版本号，文件名第三段，默认 V01
  # --- 路径配置 ---
  # 流程：extract -> work -> exchange -> input -> work -> target
   

   

# ==========================================
# 3. 资源配置 (Resources)
# ==========================================
resources:
  # --- 卸载源数据库配置（卸载任务时必填）---
  extract_database:
    host: "localhost"           # 数据库主机
    port: 54321                 # 数据库端口
    name: "source_db"           # 数据库名
    user: "reader"              # 数据库用户
    password: "password"        # 数据库密码
    database_version: "V8R6"    # 数据库版本

  # --- 加载目标数据库配置（加载任务时必填）---
  target_database:
    host: "localhost"           # 数据库主机
    port: 54321                 # 数据库端口
    name: "target_db"           # 数据库名
    user: "writer"              # 数据库用户
    password: "password"        # 数据库密码
    database_version: "V8R6"    # 数据库版本

  # --- 路径配置 ---
  # 流程：extract -> work -> exchange -> input -> work -> target
  extract_dir:
    extract_dir: "../data/extract"      # 卸载时的源文件目录（卸载时必填）
    exchange_dir: "../data/exchange"    # 卸载时的数据交换目录，用于存储xie卸载侧与加载侧交换数据
  load_dir:
    input_dir: "../data/input"          # 加载任务输入目录（文件加载时必填）
    target_dir: "../data/target"        # 加载目标目录（文件加载时必填）

# ==========================================
# 4. 任务流水线 (Tasks)
# 
# 【任务模式 (mode) 说明】
# 卸载模式：
#   - FULL: 全量卸载
#   - INCREMENTAL: 增量卸载
# 
# 加载模式：
#   - TRUNCATE_LOAD: 清空目标表后加载
#   - MERGE: 先加载到临时表，再通过 SQL 合并到目标表
#   - APPEND: 追加加载（文件直接复制到目标目录）
# 
# 【字段互斥关系】
# - tables、queries、files 三选一
# - tables: 用于表级卸载
# - queries: 用于 SQL 级卸载
# - files: 用于文件采集

# ==========================================
tasks:
  # ========================================
  # 场景1：全量表卸载
  # ========================================
  - mode: "FULL"                        # 模式：FULL（全量）| INCREMENTAL（增量）
    tables:                             # 表列表（与 queries 互斥）
      - "t_bond_info"
      - "t_bond_trade"
      - "t_bond_position"
      - "t_settlement"
    interface_mapping:                  # 可选，表名→接口编码映射（用于标准文件名）
      t_bond_info: "J0001"
      t_bond_trade: "J0002"

  # ========================================
  # 场景2：增量 SQL 卸载
  # ========================================
  - mode: "INCREMENTAL"
    queries:                            # SQL 查询列表（与 tables 互斥）
      - name: "company_info_inc"
        sql: |
          SELECT * FROM t_company_info 
          WHERE update_time >= CURRENT_DATE
      - name: "stock_trade_inc"
        sql: |
          SELECT * FROM t_stock_trade 
          WHERE trade_date = CURRENT_DATE
    interface_mapping:                  # SQL 名→接口编码映射
      company_info_inc: "J0001"
      stock_trade_inc: "J0002"

  # ========================================
  # 场景3：基于时间的文件采集（FILE_EXTRACT）
  # ========================================
  - mode: "INCREMENTAL"
    files:                              # 文件采集配置（与 tables/queries 互斥）
      pattern: "*.pdf"                  # 文件匹配模式
      time_type: "MODIFY_TIME"          # 时间类型：CREATE_TIME | MODIFY_TIME
      time_range: "LAST_1_DAY"          # 时间范围：LAST_N_DAY | LAST_N_HOUR
      size_limit_mb: 500                # 单文件大小限制（MB）

  # ========================================
  # 场景4：清空加载（TRUNCATE_LOAD）
  # ========================================
  - mode: "TRUNCATE_LOAD"               # 模式：TRUNCATE_LOAD | MERGE | APPEND
    mappings:                           # 接口编码→目标表映射
      "J0001": "t_bond_info"
      "J0002": "t_bond_trade"
    transaction: true                   # 是否启用事务，默认 true

  # ========================================
  # 场景5：合并加载（MERGE）
  # ========================================
  - mode: "MERGE"
    mappings:                           # 接口编码→临时表映射
      "J0001": "t_bond_info_back"
    merge_sql: |                        # 合并 SQL（使用临时表逻辑）
      DELETE FROM t_bond_trade
      WHERE trade_id IN (SELECT trade_id FROM t_bond_info_back);
      
      INSERT INTO t_bond_trade (trade_id, bond_id, trade_date, amount, price)
      SELECT trade_id, bond_id, trade_date, amount, price
      FROM t_bond_info_back;
    transaction: true

  # ========================================
  # 场景6：文件追加加载（FILE_LOAD）
  # ========================================
  - mode: "APPEND"
    target_dir: "/data/archive"         # 目标目录：文件还原到的目标路径（FILE_LOAD 必填）




